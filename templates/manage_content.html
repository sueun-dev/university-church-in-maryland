{% extends 'base.html' %}
{% set active_page = 'manage_content' %}
{% block title %}콘텐츠 관리 - University Church{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="mb-4">
    <h1 class="h3 mb-2">홈페이지 문구 관리</h1>
    <p class="text-muted mb-1">이 페이지에서 홈페이지의 모든 문구를 한눈에 보고 바로 수정할 수 있습니다.</p>
    <p class="text-muted mb-0">수정 후 <strong>저장</strong> 버튼을 누르면 즉시 적용됩니다. 필요하면 <strong>기본값으로</strong> 버튼으로 언제든 되돌릴 수 있습니다.</p>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="accordion" id="contentSections">
    {% for section in sections %}
    <div class="accordion-item" id="{{ section.id }}">
      <h2 class="accordion-header" id="heading-{{ section.id }}">
        <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ section.id }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="collapse-{{ section.id }}">
          {{ section.title }}
        </button>
      </h2>
      <div id="collapse-{{ section.id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading-{{ section.id }}" data-bs-parent="#contentSections">
        <div class="accordion-body">
          <p class="text-muted small mb-4">{{ section.description }}</p>
          {% for field in section.fields %}
          <form method="POST" class="card mb-3 shadow-sm border-0">
            <div class="card-body">
              <input type="hidden" name="key" value="{{ field.meta.key }}">
              <div class="mb-2">
                <label class="form-label fw-semibold" for="{{ field.meta.key }}">{{ field.meta.label }}</label>
                {% if field.meta.input_type == 'text' %}
                  <input
                    type="text"
                    class="form-control"
                    id="{{ field.meta.key }}"
                    name="content"
                    value="{{ field.value|e }}"
                  >
                {% else %}
                  <textarea
                    class="form-control"
                    id="{{ field.meta.key }}"
                    name="content"
                    rows="6"
                    data-editor-type="{{ field.meta.format }}"
                  >{{ field.value|e }}</textarea>
                {% endif %}
              </div>
              {% if field.meta.help_text %}
                <div class="form-text">{{ field.meta.help_text }}</div>
              {% endif %}
              {% if field.meta.format == 'markdown' %}
                <div class="form-text">마크다운 사용 가능: <code>**굵게**</code>, <code>- 목록</code>, <code>[링크](https://...)</code> 등</div>
              {% endif %}
              {% if field.updated_at %}
                <div class="form-text text-muted">마지막 수정: {{ field.updated_at.strftime('%Y-%m-%d %H:%M') }}</div>
              {% endif %}
              <div class="form-text text-muted">
                <span class="badge bg-light text-dark border">{{ field.meta.key }}</span>
              </div>
            </div>
            <div class="card-footer bg-white border-top-0 d-flex justify-content-end gap-2">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-reset="{{ field.meta.key }}" data-default='{{ field.meta.default|tojson|safe }}'>
                기본값으로
              </button>
              <button type="submit" class="btn btn-primary btn-sm">저장</button>
            </div>
          </form>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.querySelectorAll('[data-reset]').forEach((button) => {
      button.addEventListener('click', () => {
        const rawDefault = button.dataset.default;
        if (!rawDefault) {
          return;
        }
        let defaultValue = "";
        try {
          defaultValue = JSON.parse(rawDefault);
        } catch (error) {
          console.error("기본값을 불러오지 못했습니다.", error);
          return;
        }
        const form = button.closest("form");
        if (!form) {
          return;
        }
        const input = form.querySelector('[name="content"]');
        if (!input) {
          return;
        }
        input.value = defaultValue;
        input.focus();
      });
    });
  </script>
{% endblock %}
